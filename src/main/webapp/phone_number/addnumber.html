<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>单个添加号码</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="stylesheet" href="../static/layui/css/layui.css" media="all">
		<link rel="stylesheet" href="../static/style/admin.css" media="all">
	</head>
	<body>
		<form class="layui-form" action="">
			<div class="layui-fluid">
				<div class="layui-row layui-col-space15">
					<div class="layui-col-md12">
						<div class="layui-card">
							<div class="layui-card-body" pad15>

								<div class="layui-form" wid100 lay-filter="">
									<div class="layui-form-item">
										<label class="layui-form-label">运营商</label>
										<div class="layui-input-inline">
											<select name="wangluo" id="operator" lay-search="">
											</select>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">号码</label>
										<div class="layui-input-block">
											<input type="text" name="cellNum" id="number" placeholder="请输入手机号码" value="" class="layui-input">
											<input type="hidden" name="id" id="id" >
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">归属地</label>
										<div class="layui-input-block">
											<div class="layui-input-inline">
												<select name="provinceName" id="province" lay-search lay-filter="province">
													<option value="">全部省份</option>
												</select>
											</div>
											<div class="layui-input-inline">
												<select name="cityName" id="city" lay-search lay-filter="city">
													<option value="">全部市</option>
												</select>
											</div>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">价格设置</label>
										<div class="layui-input-block">

											<div class="layui-input-inline">
												<input type="text" name="price" id="floor_price" placeholder="底价" value="" class="layui-input">
											</div>
											<div class="layui-input-inline">
												<input type="text" name="salePrice" id="sale_price" placeholder="售价" value="" class="layui-input">
											</div>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">话费与低消</label>
										<div class="layui-input-block">

											<div class="layui-input-inline">
												<input type="text" name="huafei" id="huafei" placeholder="自带话费" value="" class="layui-input">
											</div>
											<div class="layui-input-inline">
												<input type="text" name="dixiao" id="dixiao" placeholder="低消信息" value="" class="layui-input">
											</div>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">客服电话</label>
										<div class="layui-input-block">
											<input type="text" name="serviceNum" id="servicenum" placeholder="客服电话" value="" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">首页显式</label>
										<div class="layui-input-block">
											<input type="checkbox" name="recommonded" value="1" id="recommoned" lay-skin="switch" lay-text="推荐|默认">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">自定义分类</label>
										<div class="layui-input-inline">
											<select name="category" id="category" lay-search="">
												<option value="" >可选分类</option>
											</select>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">靓号类型</label>
										<div class="layui-input-block">
											<input type="text" name="type" id="type" placeholder="靓号类型" value="" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">运营品牌</label>
										<div class="layui-input-block">
											<input type="text" name="sellerBrand" id="sellbrand" placeholder="运营品牌" value="" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">年限</label>
										<div class="layui-input-inline">
											<select name="xfYear" id="xfyear" lay-search="">
												<option value="0">无</option>
												<option value="1">一年</option>
												<option value="2">二年</option>
												<option value="3">三年</option>
											</select>
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">是否共享</label>

										<div class="layui-input-block">
											<input type="checkbox" name="share" value="1" id="share" lay-skin="switch"  lay-text="共享|私有">
										</div>
									</div>
									<div class="layui-form-item">
										<label class="layui-form-label">套餐描述</label>
										<div class="layui-input-block">
											<textarea placeholder="套餐资费说明" class="layui-textarea" name="infomation" id="infomation"></textarea>
										</div>
									</div>

									<div class="layui-form-item">
										<div class="layui-input-block">
											<button class="layui-btn" lay-submit lay-filter="add_btn">保存</button>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>

		</form>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="../static/layui/layui.js"></script>
		<script src="../static/lib/citydata.js"></script>
		<script>
			var wangluos = [{name:"联通网络"},{name:"移动网络"},{name:"电信网络"}];
            function export_all(e){
                alert(e);
            }
			layui.use(['layer', 'form', 'upload'], function() {
				var layer = layui.layer,
					form = layui.form,
					upload = layui.upload;
				//监听提交
				//在编辑时，会多传一个id
				form.on('submit(add_btn)', function(formdata) {
					console.log(formdata.field);
					var url = '../haoma/add.do';
					if(null!=formdata.field.id&&''!=formdata.field.id){
					    url="../haoma/update.do";
					}
					$.ajax({
						url: url,
						type: 'post', //真实数据，请改为post请求
						data: formdata.field, 
						dataType: 'json',
						success: function(res) {
							console.log(res);
							window.parent.location.reload(); //成功后刷新父页面
						}
					});
				});
                var province = $("#province"),
                    city = $("#city");
                //初始将省份数据赋予
                for (var i = 1; i < cityData.length; i++) {
                    if (cityData[i].parentId == 100000) {
                        addEle(province, cityData[i]);
                    }
                }
                var wangluo = $("#operator");
                for (var i = 0; i < wangluos.length; i++) {
                    var optionStr = "";
                    optionStr = "<option value=" + wangluos[i].name + " >" + wangluos[i].name + "</option>";
                    wangluo.append(optionStr);
                }

                //赋予完成 重新渲染select
                form.render('select');
                //向select中 追加内容
                function addEle(ele, value) {
                    var optionStr = "";
                    optionStr = "<option value=" + value.id +"," + value.name +" >" + value.name + "</option>";
                    ele.append(optionStr);
                }
                //移除select中所有项 赋予初始值
                function removeEle(ele) {
                    ele.find("option").remove();
                    var optionStar = "<option value="+ ">" + "请选择" + "</option>";
                    ele.append(optionStar);
                }
                var provinceId;
                //选定省份后 将该省份的数据读取追加上
                form.on('select(province)', function(data) {
                    var idAndName = data.value;
                    var arr =  idAndName.split(",");
                    provinceId = arr[0];
                    removeEle(city);
                    $.each(cityData, function(i, item) {
                        if (provinceId == item.parentId) {
                            addEle(city, item);
                        }
                    });
                    //重新渲染select
                    form.render('select');
                })
                var id = getQueryVariable("id");
                if (id) {
                    //初始化所有的分类
					$.ajax({
                        url: "../link/search.do?page=1&limit=100", //TODO
                        type: 'get',
                        dataType: 'json',
                        success: function (res) {

                            var category = $("#category");
                            for (var i = 0; i < res.data.length; i++) {
                                var optionStr = "";
                                optionStr = "<option value=" + res.data[i].id + " >" + res.data[i].name + "</option>";
                                category.append(optionStr);
                            }
                            $.ajax({
                                url: "../haoma/findOne.do", //TODO
                                type: 'get',
                                data: {
                                    'id': id
                                },
                                dataType: 'json',
                                success: function (res) {
                                    if (res.code == 10000) {
                                        //TODO
                                        $("#id").val(id);
                                        $("#number").val(res.data.cellNum);
                                        $("#floor_price").val(res.data.price);
                                        $("#sale_price").val(res.data.salePrice);
                                        $("#huafei").val(res.data.huafei);
                                        $("#dixiao").val(res.data.dixiao);
                                        category.val(res.data.category);
                                        $("#servicenum").val(res.data.serviceNum);
                                        if(res.data.recommonded==1){
                                            $("#recommoned").prop('checked',true);
                                        }
                                        $("#type").val(res.data.type);
                                        $("#sellbrand").val(res.data.sellerBrand);
                                        $("#xfyear").val(res.data.xfYear);
                                        if(res.data.share==1){
                                            $("#share").prop('checked',true);
                                        }
                                        $("#infomation").val(res.data.infomation);
                                        var form = layui.form;
                                        var wangluo = $("#operator");
                                        wangluo.val(res.data.wangluo);
                                        var province = $("#province"), city = $("#city");
                                        //初始将省份数据赋予
                                        for (var i = 1; i < cityData.length; i++) {
                                            if (cityData[i].parentId == 100000) {
                                                addEle(province, cityData[i]);
                                            }
                                        }
                                        //赋予完成 重新渲染select
                                        form.render('select');
                                        form.render('checkbox');
                                        //向select中 追加内容
                                        function addEle(ele, value) {
                                            var optionStr = "";
                                            if (value.name == res.data.provinceName) {
                                                optionStr = "<option selected value=" + value.id + "," + value.name + " >" + value.name + "</option>";
                                                removeEle(city);
                                                $.each(cityData, function (i, item) {
                                                    if (value.id == item.parentId) {
                                                        addCityEle(city, item);
                                                    }
                                                });
                                            } else {
                                                optionStr = "<option  value=" + value.id + "," + value.name + " >" + value.name + "</option>";
                                            }
                                            ele.append(optionStr);
                                        }
                                        //向select中 追加内容
                                        function addCityEle(ele, value) {
                                            var optionStr = "";
                                            if (value.name == res.data.cityName) {
                                                optionStr = "<option selected value=" + value.id + "," + value.name + " >" + value.name + "</option>";
                                            } else {
                                                optionStr = "<option  value=" + value.id + "," + value.name + " >" + value.name + "</option>";
                                            }
                                            ele.append(optionStr);
                                        }
                                        //移除select中所有项 赋予初始值
                                        function removeEle(ele) {
                                            ele.find("option").remove();
                                            var optionStar = "<option value=" + ">" + "请选择" + "</option>";
                                            ele.append(optionStar);
                                        }
                                    }
                                }
                            });
						}
					})

                }
			})
            function getQueryVariable(variable) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    if (pair[0] == variable) {
                        return pair[1];
                    }
                }
                return (false);
            }

		</script>
	</body>
</html>
